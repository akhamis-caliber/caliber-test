# Caliber - AI-Powered Inventory Scoring
# Docker Compose Management

.PHONY: help build up down restart logs clean test frontend backend mongodb redis worker

# Default target
help:
	@echo "Caliber Docker Management Commands:"
	@echo ""
	@echo "ğŸš€ Getting Started:"
	@echo "  make build      - Build all Docker images"
	@echo "  make up         - Start all services (MongoDB, Redis, Backend, Frontend)"
	@echo "  make down       - Stop all services"
	@echo "  make restart    - Restart all services"
	@echo ""
	@echo "ğŸ“Š Service Management:"
	@echo "  make frontend   - Start only frontend service"
	@echo "  make backend    - Start only backend service"
	@echo "  make mongodb    - Start only MongoDB service"
	@echo "  make redis      - Start only Redis service"
	@echo "  make worker     - Start only background worker service"
	@echo ""
	@echo "ğŸ” Monitoring & Debugging:"
	@echo "  make logs       - Show logs from all services"
	@echo "  make status     - Show status of all services"
	@echo "  make ps         - Show running containers"
	@echo ""
	@echo "ğŸ§ª Testing & Development:"
	@echo "  make test       - Run backend API tests"
	@echo "  make shell-backend  - Open shell in backend container"
	@echo "  make shell-frontend - Open shell in frontend container"
	@echo "  make shell-mongo    - Open MongoDB shell"
	@echo ""
	@echo "ğŸ§¹ Cleanup:"
	@echo "  make clean      - Remove all containers and volumes"
	@echo "  make clean-build - Clean and rebuild everything"
	@echo ""
	@echo "ğŸ“‹ Application URLs:"
	@echo "  Frontend:  http://localhost:3000"
	@echo "  Backend:   http://localhost:8000"
	@echo "  API Docs:  http://localhost:8000/docs"
	@echo "  MongoDB:   mongodb://localhost:27017"
	@echo "  Redis:     redis://localhost:6379"

# Build all Docker images
build:
	@echo "ğŸ”¨ Building Docker images..."
	docker-compose build --no-cache

# Start all services
up:
	@echo "ğŸš€ Starting all Caliber services..."
	docker-compose up -d
	@echo "âœ… All services started!"
	@echo ""
	@echo "ğŸ“‹ Service URLs:"
	@echo "  Frontend:  http://localhost:3000"
	@echo "  Backend:   http://localhost:8000"
	@echo "  API Docs:  http://localhost:8000/docs"
	@echo ""
	@echo "ğŸ” Check status with: make status"

# Start services in foreground (with logs)
up-logs:
	@echo "ğŸš€ Starting all services with logs..."
	docker-compose up

# Stop all services
down:
	@echo "ğŸ›‘ Stopping all services..."
	docker-compose down

# Restart all services
restart:
	@echo "ğŸ”„ Restarting all services..."
	docker-compose restart

# Individual service commands
frontend:
	@echo "ğŸ¨ Starting frontend service..."
	docker-compose up -d frontend

backend:
	@echo "âš¡ Starting backend service..."
	docker-compose up -d backend mongodb redis

mongodb:
	@echo "ğŸ—„ï¸  Starting MongoDB service..."
	docker-compose up -d mongodb

redis:
	@echo "ğŸ”´ Starting Redis service..."
	docker-compose up -d redis

worker:
	@echo "ğŸ‘· Starting background worker service..."
	docker-compose up -d worker

# Monitoring and debugging
logs:
	@echo "ğŸ“‹ Showing logs from all services..."
	docker-compose logs -f

logs-backend:
	docker-compose logs -f backend

logs-frontend:
	docker-compose logs -f frontend

logs-mongodb:
	docker-compose logs -f mongodb

status:
	@echo "ğŸ“Š Service Status:"
	docker-compose ps

ps:
	@echo "ğŸ³ Running containers:"
	docker-compose ps

# Development and testing
test:
	@echo "ğŸ§ª Running backend API tests..."
	cd backend && python -m pytest tests/ -v

shell-backend:
	@echo "ğŸš Opening backend container shell..."
	docker-compose exec backend /bin/bash

shell-frontend:
	@echo "ğŸš Opening frontend container shell..."
	docker-compose exec frontend /bin/sh

shell-mongo:
	@echo "ğŸƒ Opening MongoDB shell..."
	docker-compose exec mongodb mongosh -u caliber -p caliber123 --authenticationDatabase admin caliber

# Cleanup commands
clean:
	@echo "ğŸ§¹ Cleaning up containers and volumes..."
	docker-compose down -v
	docker-compose rm -f
	docker volume prune -f

clean-build:
	@echo "ğŸ§¹ Clean build - removing everything and rebuilding..."
	docker-compose down -v
	docker-compose rm -f
	docker system prune -f
	docker volume prune -f
	$(MAKE) build
	$(MAKE) up

# Environment setup
setup:
	@echo "âš™ï¸  Setting up Caliber environment..."
	cp .env.example .env
	@echo "âœ… Environment file created. Please update .env with your configuration."
	@echo ""
	@echo "ğŸ”§ To start the application:"
	@echo "  make build"
	@echo "  make up"

# Production build
build-prod:
	@echo "ğŸ—ï¸  Building production images..."
	docker-compose -f docker-compose.yml -f docker-compose.prod.yml build

# Quick development start
dev:
	@echo "ğŸš€ Starting development environment..."
	$(MAKE) build
	$(MAKE) up
	@echo ""
	@echo "ğŸ‰ Development environment is ready!"
	@echo "  Frontend: http://localhost:3000"
	@echo "  Backend:  http://localhost:8000"

# Health check
health:
	@echo "ğŸ¥ Checking service health..."
	@curl -f http://localhost:8000/api/healthz || echo "âŒ Backend health check failed"
	@curl -f http://localhost:3000 || echo "âŒ Frontend health check failed"